if(!window.TB)throw new Error("You must include the TB library before the TB_Angular library");var OpenTokAngular=angular.module("opentok",[]).factory("TB",function(){return TB}).factory("OTSession",["TB","$rootScope",function(a,b){var c={streams:[],publishers:[],init:function(d,e,f,g){this.session=a.initSession(e),c.session.on({sessionConnected:function(a){c.publishers.forEach(function(a){c.session.publish(a)})},streamCreated:function(a){b.$apply(function(){c.streams.push(a.stream)})},streamDestroyed:function(a){b.$apply(function(){c.streams.splice(c.streams.indexOf(a.stream),1)})},sessionDisconnected:function(a){b.$apply(function(){c.streams.splice(0,c.streams.length)})}}),this.session.connect(d,f,function(a){g&&g(a,c.session)}),this.trigger("init")}};return a.$.eventing(c),c}]).directive("otLayout",["$window","$parse","TB","OTSession",function(a,b,c,d){return{restrict:"E",link:function(e,f,g){var h=b(g.props)(),i=c.initLayoutContainer(f[0],h);e.$watch(function(){return f.children().length},i.layout),a.addEventListener("resize",i.layout),e.$on("otLayout",i.layout);var j=function(a){d.session.on("streamPropertyChanged",function(a){"videoDimensions"===a.changedProperty&&i.layout()})};d.session?j():d.on("init",j)}}}]).directive("otPublisher",["OTSession",function(a){return{restrict:"E",scope:{props:"&"},link:function(b,c,d){var e=b.props()||{};e.width=e.width?e.width:angular.element(c).width(),e.height=e.height?e.height:angular.element(c).height();var f=angular.element(c).children();b.publisher=TB.initPublisher(d.apikey||a.session.apiKey,c[0],e,function(a){a&&b.$emit("otPublisherError",a,b.publisher)}),angular.element(c).append(f),b.publisher.on({accessDenied:function(a){b.$emit("otAccessDenied")},accessDialogOpened:function(a){b.$emit("otAccessDialogOpened")},accessDialogClosed:function(a){b.$emit("otAccessDialogClosed")},accessAllowed:function(a){angular.element(c).addClass("allowed"),b.$emit("otAccessAllowed")},loaded:function(a){b.$emit("otLayout")},streamCreated:function(a){b.$emit("otStreamCreated")},streamDestroyed:function(a){b.$emit("otStreamDestroyed")}}),b.$on("$destroy",function(){a.session?a.session.unpublish(b.publisher):b.publisher.destroy(),a.publishers=a.publishers.filter(function(a){return a!==b.publisher}),b.publisher=null}),a.session&&(a.session.connected||a.session.isConnected&&a.session.isConnected())&&a.session.publish(b.publisher,function(a){a&&b.$emit("otPublisherError",a,b.publisher)}),a.publishers.push(b.publisher)}}}]).directive("otSubscriber",["OTSession",function(a){return{restrict:"E",scope:{stream:"=",props:"&"},link:function(b,c,d){var e=b.stream,f=b.props()||{};f.width=f.width?f.width:angular.element(c).width(),f.height=f.height?f.height:angular.element(c).height();var g=angular.element(c).children(),h=a.session.subscribe(e,c[0],f,function(a){a&&b.$emit("otSubscriberError",a,h)});h.on("loaded",function(){b.$emit("otLayout")}),angular.element(c).append(g),b.$on("$destroy",function(){a.session.unsubscribe(h)})}}}]);angular.module("app",["ngRoute","opentok","ngAnimate","ngCookies","ngResource","ngSanitize","ngTouch","ui.bootstrap","ui.bootstrap.datetimepicker","chart.js"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainController as mainCtrl"}).when("/login",{templateUrl:"views/main.html",controller:"LoginController as loginCtrl"}).when("/register",{templateUrl:"views/main.html",controller:"AuthController as AuthCtrl"}).when("/auditorium/",{templateUrl:"views/auditorium.html",controller:"RoomController as roomCtrl"}).when("/auditorium/:roomId",{templateUrl:"views/auditorium.html",controller:"RoomController as roomCtrl"}).when("/browse",{templateUrl:"views/browse.html",controller:"RoomController as roomCtrl"}).when("/profile/:userid",{templateUrl:"views/profile.html",controller:"UserController as userCtrl"}).when("/not-found",{templateUrl:"views/404.html"}).otherwise({redirectTo:"/not-found"})}]),function(){"use strict";angular.module("app").controller("MainController",["$scope","$location","$window",function(a,b,c){}])}(),function(){"use strict";angular.module("app").controller("LoginController",["AuthService","$scope","$route","$location",function(a,b,c,d){var e=this;b.errors=[],e.login=function(){b.loginForm.$valid&&(e.errors=[],a.login(e.user).success(function(a){d.path("/profile/"+a.id),console.log(a.id)}).error(function(a){b.errors.push(a),console.log(a)}))}}])}(),function(){"use strict";angular.module("app").controller("AuthController",["AuthService","$scope","$location","$routeParams",function(a,b,c,d){var e=this;e.register=function(){b.userForm.$valid&&(e.errors=[],a.register(e.user).success(function(a){console.log("RegisterController#register: "+a.id),c.path("/profile/"+a.id)}).error(function(a){_.each(a.errors,function(a,b){console.log(b+" "+a)})}))}}])}(),function(){"use strict";angular.module("app").factory("AuthService",["$http","LocalService",function(a,b){function c(b){a.get("/api/v1/auth/token_status?token="+b)}var d=b.get("auth_token");return d&&(d=angular.fromJson(b.get("auth_token")).token,c(d)),{isAuthenticated:function(){return b.get("auth_token")},login:function(c){var d=a.post("/api/v1/auth",c);return d.success(function(a){b.set("auth_token",JSON.stringify(a))}),d},logout:function(){b.unset("auth_token")},register:function(c){b.unset("auth_token");var d=a.post("/api/v1/register",c);return d.success(function(a){b.set("auth_token",JSON.stringify(a))}),d}}}]).factory("AuthInterceptor",["$q","$injector","$location",function(a,b,c){var d=b.get("LocalService"),e=d.get("auth_token");return{request:function(a){return d.get("auth_token")&&(e=angular.fromJson(d.get("auth_token")).token),e&&(a.headers.Authorization="Bearer "+e),a},responseError:function(c){return(401===c.status||403===c.status||406===c.status)&&(d.unset("auth_token"),b.get("$location").path("/login")),a.reject(c)}}}]).config(["$httpProvider",function(a){a.interceptors.push("AuthInterceptor")}])}(),function(){"use strict";angular.module("app").controller("UserController",["UserService","$scope","$location","$routeParams","$rootScope",function(a,b,c,d,e){var f=this;b.user=JSON.parse(localStorage.auth_token),a.getUsers().success(function(a){f.users=a,console.log(a)}),b.selection=[{}],b.toggleSelection=function(a){var c=b.selection.indexOf(a);c>-1?b.selection.splice(c,1):b.selection.push(a),console.log(b.selection)},a.getSingleUser(d.userid).success(function(a){f.singleUser=a,console.log(a.id)}),f.currentIndex=d.userid,f.updateInfo=function(b){a.editUser(b)},f.toggleShow=function(){f.form=!f.form},f.form=!1,a.getEvents().success(function(a){console.log(f),console.log(a.sessions),f.events=a.sessions,console.log("EVENTS:::"),console.log(f.events)}).error(function(a){console.log("There be an air-roar!")}),f.addNewEvent=function(c){a.addNewEvent(c),console.log(c),b.newEvent={},console.log(f.events)},b.sessionPage=function(){b.user=JSON.parse(localStorage.auth_token),console.log(user.id)},b.labels=["Events Attended","Average Questions Per Event","Events Moderated","Events Subscribed To","Overall Questions Asked"],b.data=[12,1.8,4,8,22],Chart.defaults.global.colours=["#1F0909","#393939","#B83535","#6C3F3F","#330F0F","#949FB1","#4D5360"]}])}(),function(){"use strict";angular.module("app").factory("UserService",["$http","LocalService","$rootScope",function(a,b,c){var d="/api/v1/profile",e="/api/v1/sessions",f=function(){return a.get(e)},g=function(b){return console.log("single event"+b),a.get(e+"/"+b)},h=function(b){return console.log("add new event: "+e),a.post(e,b)},i=function(){return a.get(d)},j=function(b){return a.get(d+"/"+b)},k=function(b,e){a.put(d+"/"+e,b),c.$broadcast("user:updated")};return{getUsers:i,getSingleUser:j,editUser:k,getEvents:f,getEvent:g,addNewEvent:h}}])}(),function(){"use strict";angular.module("app").controller("RoomController",["$scope","RoomService","OTSession","TB","$routeParams",function(a,b,c,d,e){a.initialized=!1,a.roomId=e.roomId,a.currentUserId=e.userId,a.roomMembers=[],a.stageMembers=[],a.questions=[],a.showIt=!1,a.init=function(){a.getRoomData(a.roomId),a.joinRoom(a.roomId,a.currentUserId),b.centerStageIds(a.roomId).success(function(b){console.log("centerStageIds:"+b),a.stageMembers=b})},a.getRoomData=function(c){b.getRoomData(c).success(function(b){console.log(b),a.name=b.session.name,a.desc=b.session.description,a.active=b.session.active,a.moderators=b.session.moderators,a.subscribers=b.session.subscribers})},a.joinRoom=function(d,e){b.getCredentials(d,e).success(function(b){console.log(b),a.credData=b,a.session&&a.session.disconnect(),c.init(b.OTApiKey,b.OTSessionId,b.OTToken,function(d,e){a.session=e,a.session.apiKey=b.OTApiKey;var f=function(b){a.$apply(function(){a.connected=b,b||(a.publishing=!1)})};(e.is&&e.is("connected")||e.connected)&&(console.log("65:CONNECTED"),f(!0),a.initialized=!0,a.session.signal({type:"stageChange"}),a.session.signal({type:"infoChange"})),a.session.on("sessionConnected",function(){console.log("71:sessionConnected"),f.bind(a.session,!0),a.session.signal({type:"stageChange"}),a.session.signal({type:"infoChange"})}),a.session.on("sessionDisconnected",f.bind(a.session,!1)),a.session.on("signal:infoChange",function(b){console.log("79:signal:infoChange"),a.$apply(function(){a.roomMembers=_.map(a.session.connections.where(),function(a){return Number(a.data)}),console.log("RoomMembers: "+a.roomMembers)})}),a.session.on("signal:addToCenterStage",function(b){console.log("86:singal:addToCenterStage");var c=b.data;console.log("Adding user to center stage: "+c),a.$apply(function(){a.stageMembers.push(c)})}),a.session.on("signal:removeFromCenterStage",function(b){console.log("94:signal:removeFromCenterStage");var c=b.data;console.log("Removing user from center stage: "+c);var d=a.stageMembers.indexOf(c);a.$apply(function(){a.stageMembers.splice(d,1)})}),a.session.on("signal:questionAsked",function(b){console.log("signal:questionAsked"),a.getQuestions()}),a.session.on("connectionCreated"),function(b){var c=JSON.parse(b.connection.data);console.log("User has joined room: "+c),a.session.signal({type:"infoChange"})},a.session.on("connectionDestroyed",function(b){var c=JSON.parse(b.connection.data);console.log("User has left room: "+c),a.session.signal({type:"infoChange"})}),a.streams=c.streams})})},a.centerStageToggle=function(b){var c=_.map(a.moderators,function(a){return a.id});_.includes(c,Number(a.currentUserId))&&(a.isCenterStage(b)?a.centerStageRemove(b):a.centerStageAdd(b))},a.answerQuestion=function(c){var d=_.map(a.moderators,function(a){return a.id});_.includes(d,Number(a.currentUserId))&&(console.log("Answering question:"+c),a.isCenterStage(c.user_id)||a.centerStageAdd(c.user_id),b.deleteQuestion(c.id).success(function(){a.session.signal({type:"questionAsked"})}))},a.centerStageAdd=function(b){a.session.signal({type:"addToCenterStage",data:b})},a.centerStageRemove=function(b){a.session.signal({type:"removeFromCenterStage",data:b})},a.isCenterStage=function(b){return a.initialized&&_.includes(a.stageMembers,Number(b))},a.present=function(b){return a.initialized&&(b==Number(a.currentUserId)||_.includes(a.roomMembers,b))},a.getQuestions=function(){b.getQuestions(a.roomId).success(function(b){console.log(b),a.questions=b})},a.getQuestions(),a.askQuestion=function(c,d){var e={text:c,user_id:a.currentUserId,session_id:a.roomId,order_idx:99};console.log(e),b.createQuestion(a.roomId,e).success(function(b){a.questions.push(b),a.session.signal({type:"questionAsked"})})},a.init()}])}(),function(){"use strict";angular.module("app").factory("RoomService",["$http",function(a){var b="/api/v1/sessions",c=function(c,d){return console.log("audit.service#centerStageAdd:"+c+","+d),a.post(b+"/"+c+"/center_stage/"+d)},d=function(c,d){return console.log("audit.service#centerStageRemove:"+c+","+d),a["delete"](b+"/"+c+"/center_stage/"+d)},e=function(c){return console.log("audit.service#getCenterStageIds:"+c),a.get(b+"/"+c+"/center_stage")},f=function(c,d){return console.log("#declareEnter:"+c+","+d),a.post(b+"/"+c+"/enter/"+d)},g=function(c,d){return console.log("#declareExit:"+c+","+d),a.post(b+"/"+c+"/exit/"+d)},h=function(c,d){return console.log("#getCredentials, roomId:"+c+", userId:"+d),a.get(b+"/"+c+"/credentials?userId="+d)},i=function(c){return a.get(b+"/"+c)},j=function(c){return a.get(b+"/"+c+"/questions")},k=function(c,d){var e=b+"/"+c+"/questions";return a.post(e,d)},l=function(b,c){return a.patch("http://localhost:3000/api/v1/questions/"+b)},m=function(b){return a["delete"]("/api/v1/questions/"+b)};return{centerStageAdd:c,centerStageRemove:d,centerStageIds:e,declareEnter:f,declareExit:g,getCredentials:h,getRoomData:i,getQuestions:j,createQuestion:k,updateQuestion:l,deleteQuestion:m}}])}(),function(){"use strict";angular.module("app").factory("LocalService",function(){return{get:function(a){return localStorage.getItem(a)},set:function(a,b){return localStorage.setItem(a,b)},unset:function(a){return localStorage.removeItem(a)}}})}(),angular.module("app").directive("ngEnter",function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter)}),b.preventDefault())})}});